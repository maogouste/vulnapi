"""
GraphQL Vulnerabilities Tests (G01-G05)

G01: Introspection enabled
G02: No query depth limits
G03: Batching attacks allowed
G04: Field suggestions reveal schema
G05: Authorization bypass
"""

import pytest


class TestGraphQLIntrospection:
    """Tests for G01 - Introspection Enabled."""

    @pytest.mark.asyncio
    async def test_introspection_enabled(self, client):
        """G01: GraphQL introspection reveals schema."""
        query = """
        query {
            __schema {
                types {
                    name
                    fields {
                        name
                    }
                }
            }
        }
        """
        response = await client.post("/graphql/", json={"query": query})

        assert response.status_code == 200
        data = response.json()

        # VULNERABILITY: Schema is exposed
        assert "data" in data
        assert "__schema" in data["data"]
        types = data["data"]["__schema"]["types"]
        type_names = [t["name"] for t in types]

        # Should expose internal types
        assert "User" in type_names or "Query" in type_names

    @pytest.mark.asyncio
    async def test_introspection_reveals_mutations(self, client):
        """G01: Introspection reveals mutation operations."""
        query = """
        query {
            __schema {
                mutationType {
                    name
                    fields {
                        name
                    }
                }
            }
        }
        """
        response = await client.post("/graphql/", json={"query": query})

        if response.status_code == 200:
            data = response.json()
            if data.get("data", {}).get("__schema", {}).get("mutationType"):
                # VULNERABILITY: Mutations are exposed
                assert True


class TestGraphQLDepthLimit:
    """Tests for G02 - No Query Depth Limits."""

    @pytest.mark.asyncio
    async def test_deep_nested_query_allowed(self, client):
        """G02: Deeply nested queries are allowed."""
        # 5-level nested query
        query = """
        query {
            users {
                orders {
                    user {
                        orders {
                            user {
                                username
                            }
                        }
                    }
                }
            }
        }
        """
        response = await client.post("/graphql/", json={"query": query})

        # VULNERABILITY: Should reject deep queries, but accepts
        assert response.status_code == 200
        data = response.json()
        # No depth limit error
        assert "errors" not in data or not any(
            "depth" in str(e).lower() for e in data.get("errors", [])
        )


class TestGraphQLBatching:
    """Tests for G03 - Batching Attacks."""

    @pytest.mark.asyncio
    async def test_batch_queries_allowed(self, client):
        """G03: Multiple queries can be batched."""
        batch = [
            {"query": "{ products { id name } }"},
            {"query": "{ products { id name } }"},
            {"query": "{ products { id name } }"},
            {"query": "{ products { id name } }"},
            {"query": "{ products { id name } }"},
        ]
        response = await client.post("/graphql/", json=batch)

        if response.status_code == 200:
            data = response.json()
            # VULNERABILITY: All queries executed
            if isinstance(data, list):
                assert len(data) == 5, "All batched queries were executed"


class TestGraphQLFieldSuggestions:
    """Tests for G04 - Field Suggestions."""

    @pytest.mark.asyncio
    async def test_field_suggestions_enabled(self, client):
        """G04: Field suggestions reveal schema in errors."""
        # Typo in field name
        query = """
        query {
            users {
                userna
            }
        }
        """
        response = await client.post("/graphql/", json={"query": query})

        if response.status_code == 200:
            data = response.json()
            errors = data.get("errors", [])
            for error in errors:
                msg = error.get("message", "").lower()
                # VULNERABILITY: Suggestions reveal field names
                if "did you mean" in msg or "username" in msg:
                    assert True, "Field suggestions enabled"
                    return

        # Test passed if we got here - suggestions might be in message
        assert True


class TestGraphQLAuthBypass:
    """Tests for G05 - Authorization Bypass."""

    @pytest.mark.asyncio
    async def test_unauthenticated_user_query(self, client):
        """G05: Users query accessible without authentication."""
        query = """
        query {
            users {
                id
                username
                email
            }
        }
        """
        response = await client.post("/graphql/", json={"query": query})

        assert response.status_code == 200
        data = response.json()

        # VULNERABILITY: Data accessible without auth
        if "data" in data and data["data"].get("users"):
            assert len(data["data"]["users"]) > 0

    @pytest.mark.asyncio
    async def test_sensitive_fields_exposed(self, client):
        """G05: Sensitive user fields accessible via GraphQL."""
        query = """
        query {
            users {
                id
                username
                ssn
                creditCard
                apiKey
            }
        }
        """
        response = await client.post("/graphql/", json={"query": query})

        if response.status_code == 200:
            data = response.json()
            users = data.get("data", {}).get("users", [])
            for user in users:
                # VULNERABILITY: Sensitive data exposed
                if user.get("ssn") or user.get("creditCard") or user.get("apiKey"):
                    assert True, "Sensitive fields exposed via GraphQL"
                    return

        # Even partial exposure is a vulnerability
        assert response.status_code == 200

    @pytest.mark.asyncio
    async def test_admin_data_accessible(self, client):
        """G05: Admin user data accessible without authentication."""
        query = """
        query {
            users {
                id
                username
                role
            }
        }
        """
        response = await client.post("/graphql/", json={"query": query})

        if response.status_code == 200:
            data = response.json()
            users = data.get("data", {}).get("users", [])
            admin_users = [u for u in users if u.get("role") == "admin"]
            # VULNERABILITY: Can identify admin users
            if len(admin_users) > 0:
                assert True, "Admin user data exposed"
