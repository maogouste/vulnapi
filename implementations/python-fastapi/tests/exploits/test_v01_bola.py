"""
V01 - Broken Object Level Authorization (BOLA) Tests

This vulnerability allows authenticated users to access or modify
other users' data by manipulating object IDs.
"""

import pytest


class TestBOLA:
    """Tests for V01 - Broken Object Level Authorization."""

    @pytest.mark.asyncio
    async def test_can_access_other_users_data(self, client, admin_token):
        """V01: User can access another user's data via IDOR."""
        headers = {"Authorization": f"Bearer {admin_token}"}

        # Get current user ID
        me_response = await client.get("/api/me", headers=headers)
        assert me_response.status_code == 200
        my_id = me_response.json()["id"]

        # Try to access a different user
        target_id = 2 if my_id == 1 else 1
        response = await client.get(f"/api/users/{target_id}", headers=headers)

        # VULNERABILITY: Should be 403, but returns 200
        assert response.status_code == 200
        assert response.json()["id"] == target_id

    @pytest.mark.asyncio
    async def test_sensitive_data_exposed(self, client, admin_token):
        """V01: Sensitive fields exposed when accessing other users."""
        headers = {"Authorization": f"Bearer {admin_token}"}

        # Access another user
        response = await client.get("/api/users/2", headers=headers)

        data = response.json()
        # VULNERABILITY: Sensitive fields should not be visible
        sensitive_fields = ["ssn", "credit_card", "api_key", "secret_note"]
        exposed = [f for f in sensitive_fields if f in data and data[f]]

        assert len(exposed) > 0, "Expected sensitive fields to be exposed"

    @pytest.mark.asyncio
    async def test_can_modify_other_users(self, client, admin_token):
        """V01: User can modify another user's data."""
        headers = {"Authorization": f"Bearer {admin_token}"}

        # Try to modify another user
        response = await client.put(
            "/api/users/2",
            headers=headers,
            json={"email": "hacked@evil.com"}
        )

        # VULNERABILITY: Should be 403, but modification might succeed
        # Note: Depending on implementation, this might return 200 or update partially
        assert response.status_code in [200, 422]  # 200 = vulnerable, 422 = validation error

    @pytest.mark.asyncio
    async def test_sequential_id_enumeration(self, client, admin_token):
        """V01: Can enumerate users via sequential IDs."""
        headers = {"Authorization": f"Bearer {admin_token}"}

        found_users = []
        for user_id in range(1, 10):
            response = await client.get(f"/api/users/{user_id}", headers=headers)
            if response.status_code == 200:
                found_users.append(response.json())

        # VULNERABILITY: Should not be able to enumerate all users
        assert len(found_users) >= 2, "Should find multiple users via ID enumeration"
